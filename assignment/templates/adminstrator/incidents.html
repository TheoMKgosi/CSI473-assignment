{% extends 'adminstrator/base.html' %}
{% block title %}Incidents{% endblock %}

{% block content %}
    <div class="page-header">
        <h1>Incidents</h1>
        <p>Monitor and track all reported incidents in the system</p>
    </div>

    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-number">{{ total_incidents }}</div>
            <div class="stat-label">Total Incidents Reported</div>
        </div>
        <div class="stat-card">
            <div class="stat-number">{{ incident_records }}</div>
            <div class="stat-label">Incident Reports</div>
        </div>
        <div class="stat-card">
            <div class="stat-number">{{ incidents_by_date|length }}</div>
            <div class="stat-label">Active Incident Days</div>
        </div>
        <div class="stat-card">
            <div class="stat-number">{% if incident_records > 0 %}{{ total_incidents|div:incident_records|floatformat:1 }}{% else %}0{% endif %}</div>
            <div class="stat-label">Avg Incidents per Report</div>
        </div>
    </div>

    <div class="card">
        <div class="card-header">
            <h3>Recent Incidents</h3>
        </div>
        <div class="card-body">
            {% if recent_incidents %}
                <div class="table-responsive">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Security Guard</th>
                                <th>Date</th>
                                <th>Incidents Reported</th>
                                <th>Location</th>
                                <th>Compliance Score</th>
                                <th>Notes</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for incident in recent_incidents %}
                                <tr>
                                    <td>
                                        <strong>{{ incident.security_guard.user.get_full_name|default:incident.security_guard.user.username }}</strong>
                                    </td>
                                    <td>{{ incident.date|date:"M d, Y" }}</td>
                                    <td>
                                        <span class="badge" style="background: #dc3545; color: white; font-size: 1.1em; padding: 5px 10px;">
                                            {{ incident.incidents_reported }}
                                        </span>
                                    </td>
                                    <td>{{ incident.location }}</td>
                                    <td>
                                        {% if incident.compliance_score >= 80 %}
                                            <span class="badge" style="background: #28a745; color: white;">{{ incident.compliance_score|floatformat:1 }}%</span>
                                        {% elif incident.compliance_score >= 60 %}
                                            <span class="badge" style="background: #ffc107; color: #212529;">{{ incident.compliance_score|floatformat:1 }}%</span>
                                        {% else %}
                                            <span class="badge" style="background: #dc3545; color: white;">{{ incident.compliance_score|floatformat:1 }}%</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if incident.notes %}
                                            <em>{{ incident.notes|truncatechars:50 }}</em>
                                        {% else %}
                                            <span style="color: #666;">No notes</span>
                                        {% endif %}
                                    </td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% else %}
                <div style="text-align: center; padding: 40px; color: #666;">
                    <h4>No Incidents Reported</h4>
                    <p>All security guards have reported zero incidents. Great job maintaining safety!</p>
                </div>
            {% endif %}
        </div>
    </div>

    {% if incidents_by_date %}
    <div class="card">
        <div class="card-header">
            <h3>Incident Trends (Last 30 Days)</h3>
        </div>
        <div class="card-body">
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px;">
                {% for day in incidents_by_date %}
                    <div style="text-align: center; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                        <div style="font-size: 1.5em; font-weight: bold; color: #dc3545;">{{ day.count }}</div>
                        <div style="font-size: 0.9em; color: #666;">{{ day.date|date:"M d" }}</div>
                    </div>
                {% endfor %}
            </div>
        </div>
    </div>
    {% endif %}

    <div class="card">
        <div class="card-header">
            <h3>Incident Response Guidelines</h3>
        </div>
        <div class="card-body">
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px;">
                <div style="padding: 15px; background: #f8f9fa; border-radius: 5px;">
                    <h5 style="margin: 0 0 10px 0; color: #495057;">üö® Emergency Response</h5>
                    <p style="margin: 0; font-size: 0.9em; color: #666;">For critical incidents requiring immediate police or medical response</p>
                </div>
                <div style="padding: 15px; background: #f8f9fa; border-radius: 5px;">
                    <h5 style="margin: 0 0 10px 0; color: #495057;">üìù Incident Documentation</h5>
                    <p style="margin: 0; font-size: 0.9em; color: #666;">All incidents must be documented with date, time, location, and description</p>
                </div>
                <div style="padding: 15px; background: #f8f9fa; border-radius: 5px;">
                    <h5 style="margin: 0 0 10px 0; color: #495057;">üîç Investigation Process</h5>
                    <p style="margin: 0; font-size: 0.9em; color: #666;">Follow-up investigations for serious incidents within 24 hours</p>
                </div>
                <div style="padding: 15px; background: #f8f9fa; border-radius: 5px;">
                    <h5 style="margin: 0 0 10px 0; color: #495057;">üìä Trend Analysis</h5>
                    <p style="margin: 0; font-size: 0.9em; color: #666;">Regular review of incident patterns to improve security measures</p>
                </div>
            </div>
        </div>
    </div>
{% endblock %}