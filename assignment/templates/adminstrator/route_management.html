{% extends 'adminstrator/base.html' %}
{% block title %}Route Management{% endblock %}

{% block content %}
    <div class="page-header">
        <h1>Route Management</h1>
        <p>Manage patrol routes and assign them to security guards</p>
    </div>

    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-number">{{ total_routes }}</div>
            <div class="stat-label">Total Routes</div>
        </div>
        <div class="stat-card">
            <div class="stat-number">{{ assigned_routes }}</div>
            <div class="stat-label">Assigned Routes</div>
        </div>
        <div class="stat-card">
            <div class="stat-number">{{ unassigned_routes }}</div>
            <div class="stat-label">Unassigned Routes</div>
        </div>
        <div class="stat-card">
            <div class="stat-number">{{ total_guards }}</div>
            <div class="stat-label">Total Guards</div>
        </div>
        <div class="stat-card">
            <div class="stat-number">{{ assigned_guards }}</div>
            <div class="stat-label">Assigned Guards</div>
        </div>
        <div class="stat-card">
            <div class="stat-number">{{ unassigned_guards }}</div>
            <div class="stat-label">Unassigned Guards</div>
        </div>
    </div>

    <div class="card">
        <div class="card-header">
            <h3>Patrol Routes</h3>
            <a href="{% url 'adminstrator:create_route' %}" class="btn btn-primary" style="margin-left: auto;">Create New Route</a>
        </div>
        <div class="card-body">
            {% if routes %}
                <div class="table-responsive">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Route Name</th>
                                <th>Description</th>
                                <th>Houses</th>
                                <th>Assigned Guards</th>
                                <th>Created</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for route in routes %}
                                <tr>
                                    <td>
                                        <strong>{{ route.name }}</strong>
                                    </td>
                                    <td>
                                        {% if route.description %}
                                            {{ route.description|truncatechars:50 }}
                                        {% else %}
                                            <span style="color: #666; font-style: italic;">No description</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <span class="badge" style="background: #007bff; color: white;">{{ route.houses.count }} houses</span>
                                        {% if route.houses.exists %}
                                            <br><small style="color: #666;">
                                                {% for house in route.houses.all|slice:":3" %}
                                                    {{ house.house_number }}{% if not forloop.last %}, {% endif %}
                                                {% endfor %}
                                                {% if route.houses.count > 3 %}...{% endif %}
                                            </small>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% with assigned_guards=route.assigned_guards.all %}
                                            {% if assigned_guards %}
                                                {% for guard in assigned_guards %}
                                                    <span class="badge" style="background: #28a745; color: white; margin-right: 5px;">
                                                        {{ guard.user.username }}
                                                    </span>
                                                {% endfor %}
                                            {% else %}
                                                <span class="badge" style="background: #6c757d; color: white;">Unassigned</span>
                                            {% endif %}
                                        {% endwith %}
                                    </td>
                                    <td>{{ route.created_at|date:"M d, Y" }}</td>
                                    <td>
                                        <div style="display: flex; gap: 5px; flex-wrap: wrap;">
                                            <a href="{% url 'adminstrator:edit_route' route.id %}" class="btn btn-warning btn-sm">Edit</a>
                                            <a href="{% url 'adminstrator:assign_guard_to_route' route.id %}" class="btn btn-success btn-sm">Assign Guard</a>
                                            <a href="{% url 'adminstrator:delete_route' route.id %}" class="btn btn-danger btn-sm"
                                               onclick="return confirm('Are you sure you want to delete this route?')">Delete</a>
                                        </div>
                                    </td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% else %}
                <div style="text-align: center; padding: 40px; color: #666;">
                    <h4>No Routes Created</h4>
                    <p>Get started by creating your first patrol route.</p>
                    <a href="{% url 'adminstrator:create_route' %}" class="btn btn-primary">Create First Route</a>
                </div>
            {% endif %}
        </div>
    </div>

    <div class="card">
        <div class="card-header">
            <h3>Route Management Guidelines</h3>
        </div>
        <div class="card-body">
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
                <div style="padding: 15px; background: #f8f9fa; border-radius: 5px;">
                    <h5 style="margin: 0 0 10px 0; color: #495057;">🏠 Route Planning</h5>
                    <p style="margin: 0; font-size: 0.9em; color: #666;">Create logical patrol routes that cover multiple houses efficiently. Consider geographical proximity and guard workload.</p>
                </div>
                <div style="padding: 15px; background: #f8f9fa; border-radius: 5px;">
                    <h5 style="margin: 0 0 10px 0; color: #495057;">👥 Guard Assignment</h5>
                    <p style="margin: 0; font-size: 0.9em; color: #666;">Assign routes to approved security guards. Each guard can only be assigned to one route at a time.</p>
                </div>
                <div style="padding: 15px; background: #f8f9fa; border-radius: 5px;">
                    <h5 style="margin: 0 0 10px 0; color: #495057;">📊 Performance Tracking</h5>
                    <p style="margin: 0; font-size: 0.9em; color: #666;">Monitor route completion through the Patrol tab. Guards earn compliance points for completing assigned routes.</p>
                </div>
                <div style="padding: 15px; background: #f8f9fa; border-radius: 5px;">
                    <h5 style="margin: 0 0 10px 0; color: #495057;">🔄 Route Updates</h5>
                    <p style="margin: 0; font-size: 0.9em; color: #666;">Routes can be modified at any time. Changes will affect guard assignments and compliance tracking.</p>
                </div>
            </div>
        </div>
    </div>
{% endblock %}